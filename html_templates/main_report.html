<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.TestName}} - Terminal Timeline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0d1117;
            color: #e6edf3;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.5;
            min-height: 100vh;
        }

        .header {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            color: #58a6ff;
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header .meta {
            color: #7d8590;
            font-size: 14px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2ea043;
        }

        .btn.secondary {
            background: #656d76;
        }

        .btn.secondary:hover {
            background: #768390;
        }

        .frame-info {
            margin-left: auto;
            color: #7d8590;
            font-size: 14px;
        }

        .main-display {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-bottom: 20px;
            min-height: 400px;
            padding: 16px;
        }

        .terminal-output {
            background: #000;
            color: #fff;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.3;
            padding: 16px;
            border-radius: 6px;
            overflow: auto;
            white-space: pre-wrap;
            min-height: 350px;
        }

        .frame-strip {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
        }

        .frame-strip h3 {
            color: #e6edf3;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .frames-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
        }

        .frame-thumb {
            flex: 0 0 auto;
            width: 80px;
            height: 50px;
            background: #21262d;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #7d8590;
            transition: all 0.2s;
            text-align: center;
            padding: 4px;
        }

        .frame-thumb:hover {
            border-color: #58a6ff;
            background: #0969da;
            color: white;
        }

        .frame-thumb.active {
            border-color: #238636;
            background: #2ea043;
            color: white;
        }

        .frame-num {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .frame-label {
            font-size: 9px;
            opacity: 0.8;
            word-break: break-all;
        }

        .placeholder {
            color: #7d8590;
            text-align: center;
            padding: 40px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{.TestName}}</h1>
        <div class="meta">
            Duration: {{.Duration}} | Frames: {{len .Screenshots}} | {{.Timestamp}}
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <button class="btn" id="playBtn" onclick="togglePlay()">▶ Play</button>
            <button class="btn secondary" onclick="prevFrame()">⏮ Prev</button>
            <button class="btn secondary" onclick="nextFrame()">⏭ Next</button>
            <button class="btn secondary" onclick="resetToFrame(0)">⏹ Reset</button>
            <div class="frame-info">
                <span id="frameTitle">Frame 0</span>
            </div>
        </div>

        <div class="main-display">
            <div class="terminal-output" id="terminalOutput">
                <div class="placeholder">Click a frame below to view terminal output...</div>
            </div>
        </div>

        <div class="frame-strip">
            <h3>Timeline Frames ({{len .Screenshots}})</h3>
            <div class="frames-container">
                {{range $index, $screenshot := .Screenshots}}
                <div class="frame-thumb {{if eq $index 0}}active{{end}}"
                     data-index="{{$index}}"
                     onclick="selectFrame({{$index}})"
                     title="{{$screenshot.Label}}">
                    <div class="frame-num">{{$index}}</div>
                    <div class="frame-label">{{$screenshot.Label}}</div>
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Frame data as HTML (not JSON) -->
    <div style="display: none;">
        {{range $index, $screenshot := .Screenshots}}
        <div id="frame-{{$index}}" class="frame-data">{{$screenshot.HTMLContent}}</div>
        {{end}}
    </div>

    <script>
        let currentFrame = 0;
        let totalFrames = {{len .Screenshots}};
        let isPlaying = false;
        let playInterval = null;

        function selectFrame(index) {
            if (index < 0 || index >= totalFrames) return;

            currentFrame = index;

            // Update active frame
            document.querySelectorAll('.frame-thumb').forEach(thumb => {
                thumb.classList.remove('active');
            });
            document.querySelector(`[data-index="${index}"]`).classList.add('active');

            // Update display
            const terminalOutput = document.getElementById('terminalOutput');
            const frameTitle = document.getElementById('frameTitle');
            const frameData = document.getElementById(`frame-${index}`);

            frameTitle.textContent = `Frame ${index}`;

            if (frameData && frameData.innerHTML.trim()) {
                terminalOutput.innerHTML = frameData.innerHTML;
            } else {
                terminalOutput.innerHTML = '<div class="placeholder">No terminal output for this frame</div>';
            }
        }

        function nextFrame() {
            if (currentFrame < totalFrames - 1) {
                selectFrame(currentFrame + 1);
            }
        }

        function prevFrame() {
            if (currentFrame > 0) {
                selectFrame(currentFrame - 1);
            }
        }

        function resetToFrame(index) {
            selectFrame(index);
        }

        function togglePlay() {
            const playBtn = document.getElementById('playBtn');

            if (isPlaying) {
                clearInterval(playInterval);
                playBtn.textContent = '▶ Play';
                isPlaying = false;
            } else {
                playInterval = setInterval(() => {
                    if (currentFrame < totalFrames - 1) {
                        selectFrame(currentFrame + 1);
                    } else {
                        selectFrame(0); // Loop back
                    }
                }, 800); // 800ms per frame
                playBtn.textContent = '⏸ Pause';
                isPlaying = true;
            }
        }

        // Initialize with first frame
        document.addEventListener('DOMContentLoaded', () => {
            selectFrame(0);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowRight':
                    e.preventDefault();
                    nextFrame();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    prevFrame();
                    break;
                case ' ':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'Escape':
                    if (isPlaying) {
                        togglePlay();
                    }
                    break;
                case '0':
                case '1':
                case '2':
                case '3':
                case '4':
                case '5':
                case '6':
                case '7':
                case '8':
                case '9':
                    const num = parseInt(e.key);
                    if (num < totalFrames) {
                        selectFrame(num);
                    }
                    break;
            }
        });
    </script>
    <!-- Test Metadata for Dashboard Extraction -->
    <script type="application/json" id="test-metadata">
    {
        "testName": "{{.TestName}}",
        "duration": "{{.Duration}}",
        "frameCount": {{len .Screenshots}},
        "timestamp": "{{.Timestamp}}",
        "success": {{.Success}},
        "reportType": "steadicam"
    }
    </script>
</body>
</html>